- content_for :primary_nav do
  = render :partial => 'publish/shared/navbar'

#content.wide
  %h1 Sales Reports
  .box
    %table.t1
      %thead
        %tr
          %th Date
          %th Transaction
          %th Type
          %th Qty.
          %th Sale Price
          - for fee in Fee.applicable.all 
            %th= fee.description
          %th Earnings
          %th Actions
      %tbody
        - total = 0
        - subtotal = []
        - sale_total = 0
        - @group.each do |month,sales|
          %tr
            %td{:colspan => 9}
              = month.strftime('%B').upcase
          - for sale in sales
            %tr
              %td= sale.created_at.strftime('%m/%d')
              %td= sale.id
              %td
                %strong= sale.type
              %td= sale.quantity
              %td{:align => :right}
                - sale_total += sale.total
                %strong= number_to_currency(sale.total)
              - for fv in sale.fee_versions.all
                - fv.fee.revert_to!(fv.number)
                %td{:align => :right}
                  = fee_number_to_currency(sale.collect_fees_for(fv.fee))
              %td{:align => :right}
                - subtotal << sale.total - sale.fees
                %strong= number_to_currency(subtotal.last)
              %td
                = link_to "Show", publish_publisher_sale_path(current_publisher,sale)
              - total += subtotal.last
        %tr
          %td{:colspan => 3, :align => :right}
            %strong TOTAL
          %td
          %td{:align => :right}
            %strong= number_to_currency(sale_total)
          %td
          %td
          %td{:align => :right}
            %strong= number_to_currency(total)
          %td

    %p{:align => :right} (*) Fees apply to each product sold

    %p= render :partial => 'gchart', :locals => { :sales => @sales.map { |s| s.total } }

